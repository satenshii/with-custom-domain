name: Auto Pages Domain + HTTPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  pages-domain:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Pages domain and HTTPS
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const domain = `${repo}.saten.dev`;

            // 1. Check if Pages is enabled
            let pages;
            try {
              pages = await github.request(
                "GET /repos/{owner}/{repo}/pages",
                { owner, repo }
              );
            } catch {
              console.log("Pages not enabled ‚Äî skipping");
              return;
            }

            // 2. Set custom domain
            await github.request(
              "PUT /repos/{owner}/{repo}/pages",
              {
                owner,
                repo,
                cname: domain
              }
            );
            console.log(`‚úî Domain set: ${domain}`);

            // 3. Wait for certificate issuance
            console.log("‚è≥ Waiting for TLS certificate...");
            for (let i = 0; i < 20; i++) {
              const status = await github.request(
                "GET /repos/{owner}/{repo}/pages",
                { owner, repo }
              );

              if (status.data?.https_certificate?.state === "issued") {
                console.log("üîí Certificate issued!");
                break;
              }

              if (i === 19) {
                console.log("‚ö† Cert not ready yet ‚Äî will retry on next run");
                return;
              }

              await new Promise(r => setTimeout(r, 15000)); // 15s
            }

            // 4. Enforce HTTPS
            await github.request(
              "PUT /repos/{owner}/{repo}/pages",
              {
                owner,
                repo,
                https_enforced: true
              }
            );

            console.log("‚úÖ HTTPS enforced");
